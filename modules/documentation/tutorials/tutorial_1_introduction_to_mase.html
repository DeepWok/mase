
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tutorial 1: Introduction to the Mase IR, MaseGraph and Torch FX passes &#8212; MASE 0.0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-data-viewer/jsonview.bundle.css?v=f6ef2277" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/libs/html/datatables.min.css?v=4b4fd840" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/common_css/need_style.css?v=92936fa5" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/common_css/need_core.css?v=f5b60a78" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/common_css/needstable.css?v=5e1b6797" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/common_css/need_links.css?v=2150a916" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/common_css/need_toggle.css?v=5c6620df" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-needs/modern.css?v=803738c0" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=e645c8fa"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../../_static/sphinx-data-viewer/jsonview.bundle.js?v=18cd53c5"></script>
    <script src="../../../_static/sphinx-data-viewer/jsonview_loader.js?v=f7ff7e7d"></script>
    <script src="../../../_static/sphinx-needs/libs/html/datatables.min.js?v=8a4aee21"></script>
    <script src="../../../_static/sphinx-needs/libs/html/datatables_loader.js?v=a2cae175"></script>
    <script src="../../../_static/sphinx-needs/libs/html/sphinx_needs_collapse.js?v=dca66431"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'modules/documentation/tutorials/tutorial_1_introduction_to_mase';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Tutorial 2: Finetuning Bert for Sequence Classification using a LoRA adapter" href="tutorial_2_lora_finetune.html" />
    <link rel="prev" title="Tutorials" href="../tutorials.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">MASE 0.0.1 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../installation.html">Installation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Get-started-using-Anaconda.html">Getting Started using Conda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Get-started-using-Docker.html">Getting Started using Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Get-started-using-Nix.html">Getting Started using Nix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting_started/Get-started-students.html">Additional Instructions for Imperial College Students</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Tutorial 1: Introduction to the Mase IR, MaseGraph and Torch FX passes</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_2_lora_finetune.html">Tutorial 2: Finetuning Bert for Sequence Classification using a LoRA adapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_3_qat.html">Tutorial 3: Running Quantization-Aware Training (QAT) on Bert</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_4_pruning.html">Tutorial 4: Unstructured Pruning on Bert</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_5_nas_optuna.html">Tutorial 5: Neural Architecture Search (NAS) with Mase and Optuna</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_6_mixed_precision_search.html">Tutorial 6: Mixed Precision Quantization Search with Mase and Optuna</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_7_distributed_deployment.html">Tutorial 7: Deploying a Model for Inference on Distributed Clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_8_emit_verilog.html">Tutorial 8: Autogenerating an FPGA accelerator for a Transformer Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_9_kernel_fusion.html">Tutorial 9: Running Kernel Fusion for Inference Acceleration on GPUs</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced/tensorRT_quantization_tutorial.html">Advanced: TensorRT Quantization Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced/onnxrt_quantization_tutorial.html">Advanced: ONNX Runtime Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced/cli.html">Advanced: Using Mase CLI</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer/Add-model-to-machop.html">Developer: Guide on how to add a new model into Machop</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer/doc_writing.html">Developer: How to write documentations in MASE</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer/how_to_extend_search.html">Developer: How to extend search</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../health.html">Repository Health</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../specifications.html">Coding Style Specifications</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../specifications/C-coding-style-specifications.html">C/C++ Coding Style Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/Python-coding-style-specifications.html">Python Coding Style Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/Verilog-coding-style-specifications.html">Verilog Coding Style Specifications</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Machop API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../machop.html">Machop Documentation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chop/actions.html">chop.actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/datasets.html">chop.datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/distributed.html">chop.distributed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/ir.html">chop.ir</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/models.html">chop.models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/nn.html">chop.nn</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../chop/nn_quantized.html">chop.nn.quantized</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chop/nn_quantized_functional.html">chop.nn.quantized.functional</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chop/nn_quantized_modules.html">chop.nn.quantized.modules</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../chop/passes.html">chop.passes</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../chop/passes_module.html">chop.passes.module</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../chop/module_analysis/quantization.html">chop.passes.module.transform.quantize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/module_transform/quantization.html">chop.passes.module.transform.quantize</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../chop/passes_graph.html">chop.passes.graph</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/add_metadata.html">chop.passes.graph.analysis.add_metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/autosharding.html">chop.passes.graph.analysis.autosharding</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/init_metadata.html">chop.passes.graph.analysis.init_metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/report.html">chop.passes.graph.analysis.report</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/statistical_profiler.html">chop.passes.graph.analysis.statistical_profiler.profile_statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/verify.html">chop.passes.graph.analysis.verify.verify</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/quantization.html">chop.passes.graph.calculate_avg_bits_mg_analysis_pass</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/pruning.html">chop.passes.graph.pruning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/analysis/runtime.html">chop.passes.graph.analysis.runtime</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/transform/pruning.html">chop.passes.transform.pruning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/transform/quantize.html">chop.passes.transform.quantize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/transform/verilog.html">chop.passes.transform.verilog</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/transform/utils.html">chop.passes.transform.utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/transform/tensorrt.html">chop.passes.transform.tensorrt</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/interface/save_and_load.html">chop.passes.interface.save_and_load</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/interface/tensorrt.html">chop.passes.interface.tensorrt</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../chop/interface/onnxrt.html">chop.passes.interface.onnxrt</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/pipelines.html">chop.pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chop/tools.html">chop.tools</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mase Components</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../hardware/hardware_documentation.html">Hardware Documentation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/activations.html">Activations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/activations/gelu.html">GELU</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/activations/selu.html">SELU</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/activations/softplus.html">SoftPlus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/activations/softsign.html">SoftSign</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/activations/tanh.html">Tanh</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/arithmetic.html">Arithmetic Units</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/arithmetic/mac.html">Multiply-Accumulate (MAC) Unit</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/axi.html">AXI Components</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/axi/read_master.html">AXI Read Master</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/buffers.html">Buffers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/buffers/hybrid_buffer.html">Hybrid Buffer</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/linear.html">Linear Layer</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/linear/fixed_linear.html">Fixed-Point Linear Layer</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/memory.html">Memory Components</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/memory/matrix_bank.html">Matrix Bank</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/norm.html">Normalization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/norm/batch_norm_2d.html">Batch Norm 2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/norm/group_norm_2d.html">Group Norm 2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/norm/norm.html">Normalization Module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/norm/rms_norm_2d.html">RMS Norm 2D</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../hardware/systolic_modules.html">Systolic Modules</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../hardware/systolic_modules/output_stationary.html">Output Stationary Systolic Module</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced Deep Learning Systems</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../adls_2024.html">Advanced Deep Learning Systems: 2024/2025</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/lab_0_introduction.html">Lab 0: Introduction to Mase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/lab_1_compression.html">Lab 1: Model Compression (Quantization and Pruning)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/lab_2_nas.html">Lab 2: Neural Architecture Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/lab_3_mixed_precision_search.html">Lab 3: Mixed Precision Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/lab4-hardware.html">Lab 4 (Hardware Stream) Emitting Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/lab4-software.html">Lab 4 (Software Stream) Performance Engineering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2024/setup_docker_env.html">ADLS Docker Environment Setup</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../adls_2023.html">Advanced Deep Learning Systems: 2023/2024</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2023/lab1.html">Lab 1 for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2023/lab2.html">Lab 2 for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2023/lab3.html">Lab 3 for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2023/lab4-hardware.html">Lab 4 (Hardware Stream) for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2023/lab4-software.html">Lab 4 (Software Stream) for Advanced Deep Learning Systems (ADLS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labs_2023/setup_docker_env.html">ADLS Docker Environment Setup</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/modules/documentation/tutorials/tutorial_1_introduction_to_mase.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tutorial 1: Introduction to the Mase IR, MaseGraph and Torch FX passes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-an-fx-graph-for-the-model">Generate an FX graph for the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-mase-ir">Understanding the Mase IR</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-pass-system">Understanding the Pass System</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raising-the-fx-graph-to-the-mase-ir">Raising the FX graph to the Mase IR</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-writing-an-analysis-pass">Example: writing an analysis pass</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-writing-a-transform-pass">Example: writing a transform pass</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exporting-the-masegraph">Exporting the MaseGraph</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial-1-introduction-to-the-mase-ir-masegraph-and-torch-fx-passes">
<h1>Tutorial 1: Introduction to the Mase IR, MaseGraph and Torch FX passes<a class="headerlink" href="#tutorial-1-introduction-to-the-mase-ir-masegraph-and-torch-fx-passes" title="Link to this heading">#</a></h1>
<p>In this tutorial, we’ll see how to import a model into Mase by generating a compute graph using the <a class="reference external" href="https://github.com/DeepWok/mase/blob/adls_2024/src/chop/ir/graph/mase_graph.py">MaseGraph</a> API and how to start optimizing models using analysis and transform passes. First, we’ll import a pretrained model directly from <a class="reference external" href="https://github.com/huggingface/transformers">HuggingFace Transformers</a>. For this example, we’ll use Bert for sequence classification. You can read the <a class="reference external" href="https://arxiv.org/abs/1810.04805">Bert paper</a> for information regarding the architecture.</p>
<p>We get a warning saying that some weights were not initialized, since only the weights in the decoder are pretrained and included in the HuggingFace Hub. When we use the <a class="reference external" href="https://huggingface.co/docs/transformers/model_doc/auto">AutoModelForSequenceClassification</a> API, a classification head is added at the end of the model, with randomly initialized weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;prajjwal1/bert-tiny&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/yz10513/anaconda3/envs/mase/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
Some weights of BertForSequenceClassification were not initialized from the model checkpoint at prajjwal1/bert-tiny and are newly initialized: [&#39;classifier.bias&#39;, &#39;classifier.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BertForSequenceClassification(
  (bert): BertModel(
    (embeddings): BertEmbeddings(
      (word_embeddings): Embedding(30522, 128, padding_idx=0)
      (position_embeddings): Embedding(512, 128)
      (token_type_embeddings): Embedding(2, 128)
      (LayerNorm): LayerNorm((128,), eps=1e-12, elementwise_affine=True)
      (dropout): Dropout(p=0.1, inplace=False)
    )
    (encoder): BertEncoder(
      (layer): ModuleList(
        (0-1): 2 x BertLayer(
          (attention): BertAttention(
            (self): BertSdpaSelfAttention(
              (query): Linear(in_features=128, out_features=128, bias=True)
              (key): Linear(in_features=128, out_features=128, bias=True)
              (value): Linear(in_features=128, out_features=128, bias=True)
              (dropout): Dropout(p=0.1, inplace=False)
            )
            (output): BertSelfOutput(
              (dense): Linear(in_features=128, out_features=128, bias=True)
              (LayerNorm): LayerNorm((128,), eps=1e-12, elementwise_affine=True)
              (dropout): Dropout(p=0.1, inplace=False)
            )
          )
          (intermediate): BertIntermediate(
            (dense): Linear(in_features=128, out_features=512, bias=True)
            (intermediate_act_fn): GELUActivation()
          )
          (output): BertOutput(
            (dense): Linear(in_features=512, out_features=128, bias=True)
            (LayerNorm): LayerNorm((128,), eps=1e-12, elementwise_affine=True)
            (dropout): Dropout(p=0.1, inplace=False)
          )
        )
      )
    )
    (pooler): BertPooler(
      (dense): Linear(in_features=128, out_features=128, bias=True)
      (activation): Tanh()
    )
  )
  (dropout): Dropout(p=0.1, inplace=False)
  (classifier): Linear(in_features=128, out_features=2, bias=True)
)
</pre></div>
</div>
</div>
</div>
<section id="generate-an-fx-graph-for-the-model">
<h2>Generate an FX graph for the model<a class="headerlink" href="#generate-an-fx-graph-for-the-model" title="Link to this heading">#</a></h2>
<p>To import a model into Mase, we need to generate a compute graph. In the Machine Learning community, there are several ways of capturing and representing a compute graph, such as <a class="reference external" href="https://onnx.ai/">ONNX</a>, <a class="reference external" href="https://pytorch.org/docs/stable/jit.html">Torchscript</a>, <a class="reference external" href="https://mlir.llvm.org/">MLIR</a>, <a class="reference external" href="https://tvm.apache.org/">TVM</a>, etc. Mase relies on <a class="reference external" href="https://pytorch.org/docs/stable/fx.html">Torch FX</a>, which has the following features and benefits:</p>
<ul class="simple">
<li><p><strong>High-level IR</strong>: unlike <code class="docutils literal notranslate"><span class="pre">LLVM</span></code> or <code class="docutils literal notranslate"><span class="pre">MLIR</span></code>, <code class="docutils literal notranslate"><span class="pre">FX</span></code> offers a high-level representation of the computation which enables fast optimizations.</p></li>
<li><p><strong>Pytorch native</strong>: every operator in the FX graph correlates to a Python object or callable, meaning we can transform and optimize the graph, then simply regenerate the Python code required to run it. Unlike ONNX, there is no requirement for a dedicated runtime: all you need is Python.</p></li>
</ul>
<p>When you call <code class="docutils literal notranslate"><span class="pre">MaseGraph(model)</span></code>, the <a class="reference external" href="https://github.com/DeepWok/mase/blob/main/src/chop/ir/graph/mase_graph.py">MaseTracer</a> class runs a forward pass of the model with <code class="docutils literal notranslate"><span class="pre">Proxy</span></code> objects instead of the regular <code class="docutils literal notranslate"><span class="pre">Tensor</span></code> objects. These Proxies record every operation performed on them, which is then used to generate the compute graph. The following cell generates the graph and generates a drawing of the result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">chop</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaseGraph</span>

<span class="n">mg</span> <span class="o">=</span> <span class="n">MaseGraph</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">mg</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased.svg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`past_key_values` were not specified as input names, but model.config.use_cache = True. Setting model.config.use_cache = False.
</pre></div>
</div>
</div>
</div>
<p>There are 6 different types of nodes in an FX graph: <code class="docutils literal notranslate"><span class="pre">placeholder</span></code>, <code class="docutils literal notranslate"><span class="pre">get_attr</span></code>, <code class="docutils literal notranslate"><span class="pre">call_function</span></code>, <code class="docutils literal notranslate"><span class="pre">call_module</span></code>, <code class="docutils literal notranslate"><span class="pre">call_method</span></code>, <code class="docutils literal notranslate"><span class="pre">output</span></code>. Each node has several associated attributes, such as <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">args</span></code>/<code class="docutils literal notranslate"><span class="pre">kwargs</span></code> and <code class="docutils literal notranslate"><span class="pre">target</span></code>. These have different contents and meaning depending on the node type. We provide a summary below, but for more details, see the <a class="reference external" href="https://pytorch.org/docs/stable/fx.html">FX documentation</a>.</p>
<ul class="simple">
<li><p><strong>placeholder</strong>: represents a function input, which can be a <code class="docutils literal notranslate"><span class="pre">Tensor</span></code> or another Python object.</p></li>
<li><p><strong>get_attr</strong>: retrieves a parameter from the Pytorch module hierarchy. <code class="docutils literal notranslate"><span class="pre">target</span></code> is the fully-qualified string name of the parameter’s position in the module hierarchy.</p></li>
<li><p><strong>call_function</strong>: applies a free function to some values. <code class="docutils literal notranslate"><span class="pre">target</span></code> is a handle to the Python callable. <code class="docutils literal notranslate"><span class="pre">args</span></code> and <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> represent the arguments to the function, following the Python calling convention.</p></li>
<li><p><strong>call_module</strong>: applies a module in the module hierarchy’s <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method with the given arguments. <code class="docutils literal notranslate"><span class="pre">target</span></code> is the fully-qualified string name of the module in the module hierarchy to call.</p></li>
<li><p><strong>call_method</strong>: calls a method on a value. <code class="docutils literal notranslate"><span class="pre">target</span></code> is the string name of the method to apply to the self argument.</p></li>
<li><p><strong>output</strong>: contains the output of the traced function in its args[0] attribute. This corresponds to the <code class="docutils literal notranslate"><span class="pre">return</span></code> statement in the Graph printout.</p></li>
</ul>
<p>You may be wondering the difference between <code class="docutils literal notranslate"><span class="pre">call_function</span></code>, <code class="docutils literal notranslate"><span class="pre">call_method</span></code> and <code class="docutils literal notranslate"><span class="pre">call_module</span></code> nodes: <code class="docutils literal notranslate"><span class="pre">call_function</span></code> nodes can have arbitrary Python callable as targets, while the target for <code class="docutils literal notranslate"><span class="pre">call_method</span></code> nodes must be a <code class="docutils literal notranslate"><span class="pre">Tensor</span></code> class method. <code class="docutils literal notranslate"><span class="pre">call_module</span></code> nodes refer to <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> objects which must be included in the Pytorch module hierarchy. For example, the Pytorch ReLU activation function can be seen any of these node types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">random_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">function_relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">random_tensor</span><span class="p">)</span>
<span class="n">method_relu</span> <span class="o">=</span> <span class="n">random_tensor</span><span class="o">.</span><span class="n">relu</span><span class="p">()</span>
<span class="n">module_relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()(</span><span class="n">random_tensor</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">function_relu</span><span class="p">,</span> <span class="n">method_relu</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">function_relu</span><span class="p">,</span> <span class="n">module_relu</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Open the generated SVG file (you may find this <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=SimonSiefke.svg-preview">VSCode extension</a> useful) and inspect each node. If you can’t generate the image, we show below a segment of the graph that corresponds to the first attention layer of the Bert encoder. If you also inspect the <a class="reference external" href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/bert/modeling_bert.py">Bert implementation</a> in the HuggingFace repository, you can see how each node in the generated graph corresponds to lines in the Python code. For example, the <code class="docutils literal notranslate"><span class="pre">bert_encoder_layer_0_attention_self_&lt;query/key/value&gt;</span></code> nodes correspond to the calls to the Query/Key/Value linear layers defined in the <code class="docutils literal notranslate"><span class="pre">BertSelfAttention</span></code> class. You can also see how not every piece of code has an associated node in the graph - when the code is being symbolically traced, parts of the code that aren’t executed (for example, if statements which never yield <code class="docutils literal notranslate"><span class="pre">True</span></code>) don’t interact with the <code class="docutils literal notranslate"><span class="pre">Proxy</span></code> objects, hence they’re not included in the graph.</p>
<a class="reference internal image-reference" href="../../../_images/fx_graph_bert_base_uncased_num_hidden_layers_1_segment.png"><img alt="drawing" src="../../../_images/fx_graph_bert_base_uncased_num_hidden_layers_1_segment.png" style="width: 1200px;" />
</a>
</section>
<section id="understanding-the-mase-ir">
<h2>Understanding the Mase IR<a class="headerlink" href="#understanding-the-mase-ir" title="Link to this heading">#</a></h2>
<p>As previously mentioned, the Mase IR is built on top of Torch FX. However, the FX operator associated with each node in the graph refers broadly to Python semantics, such as how to execute code generation for a transformed graph. For example, when the FX code generator encounters a <code class="docutils literal notranslate"><span class="pre">call_function</span></code> node, it would know to generate code equivalent to <code class="docutils literal notranslate"><span class="pre">node.target(*node.args,</span> <span class="pre">**node.kwargs)</span></code>, while for <code class="docutils literal notranslate"><span class="pre">call_method</span></code> nodes, the code would correspond to <code class="docutils literal notranslate"><span class="pre">getattr(node.args[0],</span> <span class="pre">node.target)(*args[1:],</span> <span class="pre">**kwargs)</span></code>. However, beyond code generation, the FX IR has no information regarding the workload being executed by the graph - that’s where the Mase IR comes in.</p>
<p>As described in previous publications, the major benefit of the Mase IR is in offering a common abstraction layer for both hardware and software workloads (see <a class="reference external" href="https://arxiv.org/abs/2307.15517">here</a>, <a class="reference external" href="https://openreview.net/forum?id=Z7v6mxNVdU">here</a>). You can find a list of Mase operators under the <a class="reference external" href="https://github.com/DeepWok/mase/blob/main/src/chop/ir/common.py">IR definition file</a>. You can see that most operators correspond strongly with either Pytorch or ONNX operators. Each operator is also associated with a node type, which can be one of the following.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">module_related_func</span></code>: includes functions under <code class="docutils literal notranslate"><span class="pre">torch.nn.functional</span></code> and the <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> that wraps them. For example, <code class="docutils literal notranslate"><span class="pre">torch.nn.functional.relu</span></code> and <code class="docutils literal notranslate"><span class="pre">torch.nn.ReLU</span></code> both fall under this category.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">module</span></code>: a MASE module is a subclass of <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> that does not have corresponding <code class="docutils literal notranslate"><span class="pre">torch.nn.functional</span></code> counterpart. For example, <code class="docutils literal notranslate"><span class="pre">torch.nn.BatchNorm2D</span></code> is a MASE module because <code class="docutils literal notranslate"><span class="pre">torch.nn.functional.batch_norm_2d</span></code> does not exist.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">builtin_func</span></code>: MASE builtin_func includes functions under <code class="docutils literal notranslate"><span class="pre">torch</span></code> that are not <code class="docutils literal notranslate"><span class="pre">torch.nn.functional</span></code> and <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code>, such as <code class="docutils literal notranslate"><span class="pre">torch.cat</span></code> and <code class="docutils literal notranslate"><span class="pre">torch.bmm</span></code>.</p></li>
</ul>
<p>The following types are also present, which have the same meaning as in Torch FX.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">placeholder</span></code>: input node of a MASEGraph.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_attr</span></code>: represents the attribute of a MASE module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output</span></code>: equivalent to the return statement in the forward function.</p></li>
</ul>
</section>
<section id="understanding-the-pass-system">
<h2>Understanding the Pass System<a class="headerlink" href="#understanding-the-pass-system" title="Link to this heading">#</a></h2>
<p>If you have worked with compilers, you might be familiar with the concept of a pass, which is a function that iterates over each node in the graph to perform some task. In Mase, there are two categories of passes: analysis and transform passes.</p>
<ul class="simple">
<li><p><strong>Analysis passes</strong>: extract some information about each node, annotate nodes with relevant data, and generate payloads to be used by subsequent passes.</p></li>
<li><p><strong>Transform passes</strong>: change the topology of the graph by inserting, removing or replacing nodes.</p></li>
</ul>
<p>All passes, whether analysis or transform, have the following structure. Every pass accepts a dictionary <code class="docutils literal notranslate"><span class="pre">pass_args</span></code> containing required arguments, and outputs a tuple of the output graph (which can be annotated or transformed) and a <code class="docutils literal notranslate"><span class="pre">pass_outputs</span></code> dictionary. A pass doesn’t need to use any arguments or generate any outputs (other than the output graph), however the argument and return signatures must follow this standard such that passes can be chained together.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span><span class="w"> </span><span class="nf">dummy_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="n">pass_args</span><span class="o">=</span><span class="p">{}):</span>
    
    <span class="c1"># ... do some setup </span>
    <span class="n">pass_outputs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mg</span><span class="o">.</span><span class="n">fx_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="c1"># ... do stuff</span>

    <span class="k">return</span> <span class="n">mg</span><span class="p">,</span> <span class="n">pass_outputs</span>

</pre></div>
</div>
<p>Next, we’ll show how to run some analysis passes required to raise the generated FX graph to the Mase IR. Then, we’ll come back to see how to write some simple analysis passes to do useful things.</p>
</section>
<section id="raising-the-fx-graph-to-the-mase-ir">
<h2>Raising the FX graph to the Mase IR<a class="headerlink" href="#raising-the-fx-graph-to-the-mase-ir" title="Link to this heading">#</a></h2>
<p>To convert the simple FX graph we generated into the Mase IR, we must run the following analysis passes, which annotate each node with relevant metadata. Note that metadata follows under three categories: <code class="docutils literal notranslate"><span class="pre">common</span></code>, <code class="docutils literal notranslate"><span class="pre">hardware</span></code> and <code class="docutils literal notranslate"><span class="pre">software</span></code>. Hardware metadata is used for generating FPGA accelerators in the <a class="reference external" href="https://github.com/DeepWok/mase/tree/adls_2024/src/chop/passes/graph/transforms/verilog">emit Verilog toolflow</a> (see Lab 4), while software metadata is used by passes such as <a class="reference external" href="https://github.com/DeepWok/mase/tree/main/src/chop/passes/graph/analysis/autosharding">autosharding</a>, which automatically finds a model parallelism configuration in a GPU cluster. Common metadata is generally required by all workflows in Mase.</p>
<ul class="simple">
<li><p><strong>init_metadata_analysis_pass</strong>: initializes a <code class="docutils literal notranslate"><span class="pre">MaseMetadata</span></code> object for each node in the graph, which behaves like a dictionary and is stored under <code class="docutils literal notranslate"><span class="pre">node.meta[&quot;mase&quot;]</span></code>. Each metadata instance has the following structure, which is empty at initialization. See <a class="reference external" href="https://deepwok.github.io/mase/modules/api/analysis/init_metadata.html">here</a> for details on the implementation.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="n">node</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;mase&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;hardware&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;software&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>add_common_metadata_analysis_pass</strong>: populates the <code class="docutils literal notranslate"><span class="pre">node.meta[&quot;mase&quot;][&quot;common&quot;]</span></code> dictionary by executing the following two steps. See <a class="reference external" href="https://deepwok.github.io/mase/modules/api/analysis/add_metadata.html">here</a> for details on the implementation.</p>
<ul>
<li><p><strong>Operator inference</strong>: determine the operator associated with each node in the graph from its fx operator and target, and annotate under <code class="docutils literal notranslate"><span class="pre">node.meta[&quot;mase&quot;][&quot;common&quot;][&quot;mase_op&quot;]</span></code></p></li>
<li><p><strong>Shape Propagation</strong>: similarly to the <a class="reference external" href="https://pytorch.org/docs/stable/fx.html#the-interpreter-pattern">Interpreter Pattern</a> in the FX documentation, this involves running a forward pass of the entire model with a provided dummy input, and observing the Tensor metadata (shape, data type, stride, etc) of each argument and result for every node in the graph. This is then annotated under <code class="docutils literal notranslate"><span class="pre">node.meta[&quot;mase&quot;][&quot;common&quot;][&quot;args&quot;]</span></code> and <code class="docutils literal notranslate"><span class="pre">node.meta[&quot;mase&quot;][&quot;common&quot;][&quot;results&quot;]</span></code>.</p></li>
</ul>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">add_common_metadata_analysis_pass</span></code> requires a dummy Tensor input to run the shape propagation step. In the following cell, we show how this can be done using the HuggingFace tokenizer, to which we pass two truthful statements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">chop.passes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">passes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;bert-base-uncased&quot;</span><span class="p">)</span>

<span class="n">dummy_input</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;AI may take over the world one day&quot;</span><span class="p">,</span>
        <span class="s2">&quot;This is why you should learn ADLS&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">mg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">passes</span><span class="o">.</span><span class="n">init_metadata_analysis_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>
<span class="n">mg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">passes</span><span class="o">.</span><span class="n">add_common_metadata_analysis_pass</span><span class="p">(</span>
    <span class="n">mg</span><span class="p">,</span>
    <span class="n">pass_args</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;dummy_in&quot;</span><span class="p">:</span> <span class="n">dummy_input</span><span class="p">,</span>
        <span class="s2">&quot;add_value&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-writing-an-analysis-pass">
<h2>Example: writing an analysis pass<a class="headerlink" href="#example-writing-an-analysis-pass" title="Link to this heading">#</a></h2>
<p>Writing an analysis pass is often simple - in the following example, we implement a pass which counts the number of dropout layers in the graph. We also show how to use the <code class="docutils literal notranslate"><span class="pre">get_logger</span></code> API from <code class="docutils literal notranslate"><span class="pre">chop.tools</span></code> to provide information about the graph to the user at runtime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">chop.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;mase_logger&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">count_dropout_analysis_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="n">pass_args</span><span class="o">=</span><span class="p">{}):</span>

    <span class="n">dropout_modules</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dropout_functions</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mg</span><span class="o">.</span><span class="n">fx_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;call_module&quot;</span> <span class="ow">and</span> <span class="s2">&quot;dropout&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found dropout module: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dropout_modules</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping node: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mg</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dropout_count&quot;</span><span class="p">:</span> <span class="n">dropout_modules</span> <span class="o">+</span> <span class="n">dropout_functions</span><span class="p">}</span>


<span class="n">mg</span><span class="p">,</span> <span class="n">pass_out</span> <span class="o">=</span> <span class="n">count_dropout_analysis_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dropout count is: </span><span class="si">{</span><span class="n">pass_out</span><span class="p">[</span><span class="s1">&#39;dropout_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-writing-a-transform-pass">
<h2>Example: writing a transform pass<a class="headerlink" href="#example-writing-a-transform-pass" title="Link to this heading">#</a></h2>
<p>In this example, we delete all dropout nodes from the graph. Dropout is a useful training technique, but it doesn’t have any effect on the activations at inference time, hence these nodes can be removed to simplify the graph. Transform passes may involve deleting, inserting, or replacing nodes in the graph. When doing this, we must carefully handle the arguments to ensure the graph topology is valid after transformation. Before erasing the dropout nodes, we must first find all other nodes that take the output of the dropout node as arguments, by running <code class="docutils literal notranslate"><span class="pre">node.replace_all_uses_with</span></code>. Without doing this, there would still be nodes that require arguments that no longer exist.</p>
<blockquote>
<div><p><strong>Task</strong>: Delete the call to <code class="docutils literal notranslate"><span class="pre">replace_all_uses_with</span></code> to verify that FX will report a RuntimeError.</p>
</div></blockquote>
<p>Finally, we rerun the analysis pass previously implemented to recount the number of dropout modules, and verify this is now zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.fx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fx</span>


<span class="k">def</span><span class="w"> </span><span class="nf">remove_dropout_transform_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="n">pass_args</span><span class="o">=</span><span class="p">{}):</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">mg</span><span class="o">.</span><span class="n">fx_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;call_module&quot;</span> <span class="ow">and</span> <span class="s2">&quot;dropout&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing dropout module: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Replace all users of the dropout node with its parent node</span>
            <span class="n">parent_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This dropout module has parent node: </span><span class="si">{</span><span class="n">parent_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">replace_all_uses_with</span><span class="p">(</span><span class="n">parent_node</span><span class="p">)</span>

            <span class="c1"># Erase the dropout node</span>
            <span class="n">mg</span><span class="o">.</span><span class="n">fx_graph</span><span class="o">.</span><span class="n">erase_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping node: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mg</span><span class="p">,</span> <span class="p">{}</span>


<span class="n">mg</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">remove_dropout_transform_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>
<span class="n">mg</span><span class="p">,</span> <span class="n">pass_out</span> <span class="o">=</span> <span class="n">count_dropout_analysis_pass</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">pass_out</span><span class="p">[</span><span class="s2">&quot;dropout_count&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="exporting-the-masegraph">
<h2>Exporting the MaseGraph<a class="headerlink" href="#exporting-the-masegraph" title="Link to this heading">#</a></h2>
<p>You can export the transformed MaseGraph to be shared and used in future tutorials, by running the <code class="docutils literal notranslate"><span class="pre">mg.export()</span></code> command.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">mg</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="si">}</span><span class="s2">/tutorial_1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After exporting, you can pick up where you left off by running the <code class="docutils literal notranslate"><span class="pre">MaseGraph.from_checkpoint</span></code> constructor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_mg</span> <span class="o">=</span> <span class="n">MaseGraph</span><span class="o">.</span><span class="n">from_checkpoint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="si">}</span><span class="s2">/tutorial_1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../tutorials.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tutorials</p>
      </div>
    </a>
    <a class="right-next"
       href="tutorial_2_lora_finetune.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tutorial 2: Finetuning Bert for Sequence Classification using a LoRA adapter</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-an-fx-graph-for-the-model">Generate an FX graph for the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-mase-ir">Understanding the Mase IR</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-pass-system">Understanding the Pass System</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#raising-the-fx-graph-to-the-mase-ir">Raising the FX graph to the Mase IR</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-writing-an-analysis-pass">Example: writing an analysis pass</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-writing-a-transform-pass">Example: writing a transform pass</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exporting-the-masegraph">Exporting the MaseGraph</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By DeepWok
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, DeepWok.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>