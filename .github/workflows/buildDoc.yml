name: Build Doc for the MASE website 

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    logLevel:
          description: 'Log level'
          required: true
          default: 'warning'
          type: choice
          options:
            - info
            - warning
            - debug
  

jobs:

  software-regression-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/jianyicheng/mase-docker/mase-ci-build:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.MASE_DOCKER_CRED }}
    steps:
        - name: Install dependencies
          run: |
            pip install networkx==2.6.3
            pip install pyyaml==5.4.1
            pip install torchvision>=0.10.0
            pip install torch>=1.9.0
            pip install fvcore==0.1.5.post20210630
            pip install pytest==6.2.4
            pip install lightgbm==3.2.1
            pip install ngboost==0.3.11
            pip install xgboost==1.4.2
            pip install emcee==3.1.0
            pip install pybnn==0.0.5
            pip install grakel==0.1.8
            pip install pyro-ppl==1.6.0

            # additional from setup.py prev
            pip install tqdm==4.61.1
            pip install scikit-learn==1.0.2
            pip install scikit-image==0.19.2
            pip install pytorch-msssim==0.2.1
            pip install tensorwatch==0.9.1

            # from zerocost
            pip install transforms3d
            pip install gdown
      # Clone the MASE repo and its submodules.
      - name: Get MASE
        uses: actions/checkout@v3
        with:
            submodules: "true"

      - name: Set git safe
        run: |
          git config --global --add safe.directory $PWD

      - name: Build sphinx html
        run: |
          export PYTHONPATH="${PATH}:$(pwd):$(pwd)/machop"
          cd machop/sphinx_docs
          make html 2>&1 | tee html.log
          ! grep -rn html.log -e "Error" || exit 1
          cd ../..

      - name: Run ghp-import
        run: |
          ghp-import -n -p -f machop/sphinx_docs/build/html

