# use flake - explicitly specify current directory
use flake .

# Use UV to create venv if there isn't any
# IMPORTANT: Use Nix's Python 3.11 (required by mase project) to avoid GLIBC compatibility issues
# The virtual environment Python must match the glibc version used by Nix tools
if [ ! -e .venv ]; then
    # Use Nix's python3.11 which is compatible with Nix's glibc and meets mase requirements (>=3.11.9)
    uv venv --python python3.11  # Use Nix's Python 3.11 (required by mase project)

    # --- Installing Core Dependencies via setup.py ---
    
    # 1. Install PyTorch and torchvision with CUDA support
    uv pip install torch==2.6.0+cu126 --extra-index-url https://download.pytorch.org/whl/cu126
    uv pip install torchvision==0.21.0+cu126 --extra-index-url https://download.pytorch.org/whl/cu126

    # 2. Install the main project and all other dependencies from setup.py in editable mode.
    #    This reads the extensive 'install_requires' list from setup.py.
    uv pip install -e . || echo "Warning: Could not install main project and dependencies from setup.py"
    
fi

source .venv/bin/activate

# Add tools directory to Python path so quant module can be found
export PYTHONPATH="$PWD/tools:${PYTHONPATH:-}"

# Find the actual PyTorch library path
TORCH_LIB_PATH=$(python -c "import torch; print(torch.utils.cmake_prefix_path + '/lib')" 2>/dev/null || echo "$PWD/.venv/lib/python3.11/site-packages/torch/lib")

# Use PyTorch pre-built library to avoid supplying our own.
export LIBTORCH_USE_PYTORCH=1
export LIBTORCH_BYPASS_VERSION_CHECK=1

# Add GCC C++ standard library and PyTorch library paths,
GCC_LIB_PATH="${NIX_GCC_LIB:-$(nix-build '<nixpkgs>' -A gcc.cc.lib --no-out-link 2>/dev/null)/lib}"
ZLIB_LIB_PATH="${NIX_ZLIB_LIB:-$(nix-build '<nixpkgs>' -A zlib --no-out-link 2>/dev/null)/lib}"
# Add libglvnd (OpenGL) library paths for opencv-python (libGL.so.1)
# libGL.so.1 is actually in libglvnd, not mesa
LIBGLVND_LIB_PATH="${NIX_LIBGLVND_LIB:-$(nix-build '<nixpkgs>' -A libglvnd --no-out-link 2>/dev/null)/lib}"
# Add glib library path (contains libgthread-2.0.so.0 needed by opencv-python)
GLIB_LIB_PATH="${NIX_GLIB_LIB:-$(nix-build '<nixpkgs>' -A glib.out --no-out-link 2>/dev/null)/lib}"

# Set library paths for both runtime and linking
export LD_LIBRARY_PATH="${GLIB_LIB_PATH}:${LIBGLVND_LIB_PATH}:/run/opengl-driver/lib:${TORCH_LIB_PATH}:${GCC_LIB_PATH}:${ZLIB_LIB_PATH}:${LD_LIBRARY_PATH:-}"

export LD_PRELOAD=/usr/lib64/libcuda.so.1

echo "Using PyTorch libraries from: ${TORCH_LIB_PATH}"